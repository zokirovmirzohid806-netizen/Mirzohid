<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Tizimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .hidden { display: none !important; }
        .shake {
            animation: shake 0.2s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .pulse-green {
            animation: pulseGreen 0.2s ease-in-out;
        }
        @keyframes pulseGreen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* MOBIL MOSLASHUV (TELEFON UCHUN) */
        @media (max-width: 640px) {
            body {
                padding: 8px !important;
                background-color: #f3f4f6; /* Telefonlarda fon rangini aniqroq ko'rsatish */
            }
            .container {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 10px !important;
                border-radius: 12px !important; /* Burchaklarni yumshatish */
            }
            /* Savol va javob tugmalarini telefonda kattaroq qilish */
            button, .answer-button {
                min-height: 50px !important; /* Barmoq bilan bosish oson bo'ladi */
                font-size: 15px !important;
                margin-bottom: 10px !important;
                padding: 12px !important;
            }
            /* Admin jadvali telefonga sig'masa o'ngga suriladi */
            .overflow-x-auto {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            h1 {
                font-size: 1.4rem !important;
                line-height: 1.2 !important;
            }
            /* Quiz kartasini telefon ekraniga moslash */
            .bg-white {
                padding: 15px !important;
            }
        }
    </style>
        /* Mobil qurilmalar uchun moslashuv */
                @media (max-width: 640px) {
                    body {
                        padding: 10px;
                    }
                    .container {
                        width: 100% !important;
                        max-width: 100% !important;
                        margin: 0 !important;
                        padding: 10px !important;
                    }
                    /* Tugmalarni telefonda bosishga qulay qilish */
                    button, .answer-button {
                        padding: 14px 10px !important;
                        font-size: 14px !important;
                        margin-bottom: 8px !important;
                    }
                    /* Admin jadvalini scroll bo'ladigan qilish */
                    .overflow-x-auto {
                        display: block;
                        width: 100%;
                        overflow-x: auto;
                        -webkit-overflow-scrolling: touch;
                    }
                    h1 {
                        font-size: 1.25rem !important;
                        line-height: 1.5rem !important;
                    }
                }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // --- SUPABASE SOZLAMALARI ---
        const SUPABASE_URL = 'https://mngoeyajoeftbjxhmemi.supabase.co'
        const SUPABASE_KEY = 'sb_publishable_3eCSX5XUMJr-d_jdyj5bCw_XzdYI41F';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configure PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Icons as SVG strings
        const icons = {
            award: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>',
            logout: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>',
            fileText: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
            checkCircle: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            xCircle: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            barChart: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>',
            arrowLeft: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>',
            arrowRight: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>',
            home: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>',
            users: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
            upload: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>',
            plus: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>',
            edit: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
            trash: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>',
            trending: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>',
            clock: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            save: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>',
            pencil: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>',
            lock: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>',
            chevronDown: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>',
            send: '<svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>',
            ban: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>',
            userCheck: '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>'
        };

        // State management
        let state = {
            currentUser: null,
            isAdmin: false,
            currentScreen: 'login',
            sections: [],
            currentSection: null,
            currentSubsection: null,
            currentQuestionIndex: 0,
            userAnswers: [],
            quizResults: null,
            allUsersStats: [],
            startTime: null,
            elapsedTime: 0,
            timerInterval: null,
            showingFeedback: false,
            editingQuestion: null,
            tempUploadedQuestions: null,
            showManualEntry: false,
            userSectionPassword: null,
            expandedUserStats: {},
            shuffledQuestions: null,
            isTelegramUser: false,
            blockedUsers: [],
            expandedSubsections: {},
            addingQuestionTo: null
        };

        // --- SUPABASE ORQALI MA'LUMOT YUKLASH ---
        async function loadData() {
            try {
                // Supabase'dan ma'lumotni olamiz
                const { data, error } = await _supabase
                    .from('quiz_data')
                    .select('content')
                    .eq('id', 1)
                    .single();

                if (data && data.content) {
                    // Agar ma'lumot string bo'lsa JSON.parse qilamiz, ob'ekt bo'lsa o'zini olamiz
                    const parsed = typeof data.content === 'string' ? JSON.parse(data.content) : data.content;

                    if (parsed.sections) state.sections = parsed.sections;
                    if (parsed.stats) state.allUsersStats = parsed.stats;
                    if (parsed.blocked) state.blockedUsers = parsed.blocked;

                    // Ekranni yangilaymiz
                    render();
                } else {
                    console.log("Bazada ma'lumot yo'q, boshlang'ich holat.");
                }
            } catch (err) {
                console.error("Ma'lumotlarni yuklashda xatolik:", err);
            }
        }

        // --- SUPABASE ORQALI MA'LUMOT SAQLASH ---
        async function saveData() {
            const dataToSave = {
                sections: state.sections,
                stats: state.allUsersStats,
                blocked: state.blockedUsers
            };

            try {
                const { error } = await _supabase
                    .from('quiz_data')
                    .upsert({ id: 1, content: dataToSave });

                if (error) {
                    console.error("Saqlashda xato:", error.message);
                    alert("Ma'lumot saqlanmadi: " + error.message);
                } else {
                    console.log("Bazaga muvaffaqiyatli saqlandi!");
                }
            } catch (err) {
                console.error("Saqlashda jiddiy xatolik:", err);
                alert("Internet bilan aloqani tekshiring!");
            }
        }

        // Clean old stats (older than 30 days)
        function cleanOldStats() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const initialLength = state.allUsersStats.length;
            state.allUsersStats = state.allUsersStats.filter(stat =>
                new Date(stat.date) > thirtyDaysAgo
            );

            // Agar eski statistika o'chirilgan bo'lsa, bazaga yangilab qo'yamiz
            if (state.allUsersStats.length !== initialLength) {
                saveData();
            }
        }

        // Block/Unblock user functions
        function blockUser(telegramNick) {
            if (!state.blockedUsers.includes(telegramNick)) {
                state.blockedUsers.push(telegramNick);
                saveData();
                alert(`${telegramNick} bloklandi!`);
                render();
            }
        }

        function unblockUser(telegramNick) {
            state.blockedUsers = state.blockedUsers.filter(nick => nick !== telegramNick);
            saveData();
            alert(`${telegramNick} blokdan chiqarildi!`);
            render();
        }

        function isUserBlocked(telegramNick) {
            return state.blockedUsers.includes(telegramNick);
        }

        // Shuffle array
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Shuffle questions
        function shuffleQuestions(questions) {
            return questions.map(q => {
                const optionsWithIndex = q.options.map((opt, idx) => ({
                    text: opt,
                    wasCorrect: idx === q.correctAnswer
                }));

                const shuffledOptions = shuffleArray(optionsWithIndex);

                return {
                    question: q.question,
                    options: shuffledOptions.map(o => o.text),
                    correctAnswer: shuffledOptions.findIndex(o => o.wasCorrect)
                };
            });
        }

        // Timer functions
        function startTimer() {
            state.startTime = Date.now();
            state.elapsedTime = 0;
            state.timerInterval = setInterval(() => {
                state.elapsedTime = Math.floor((Date.now() - state.startTime) / 1000);
                updateTimer();
            }, 1000);
        }

        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        function updateTimer() {
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                const minutes = Math.floor(state.elapsedTime / 60);
                const seconds = state.elapsedTime % 60;
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        // Parse DOCX content
        async function parseDocxContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        resolve(result.value);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Parse PDF content
        async function parsePdfContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const typedArray = new Uint8Array(e.target.result);
                        const loadingTask = pdfjsLib.getDocument(typedArray);
                        const pdf = await loadingTask.promise;
                        let fullText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item =>
                                item.str + (item.hasEOL ? '\n' : ' ')
                            ).join('');
                            fullText += pageText + '\n';
                        }
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Parse questions from text - MAXSUS FAYLINGIZ UCHUN MOSLASHTIRILDI
        function parseQuestions(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const questions = [];
            let currentQuestion = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (/^\d+[\.\)]/.test(line) || (!currentQuestion && line.length > 10)) {
                    if (currentQuestion && currentQuestion.options.length > 0) {
                        questions.push(currentQuestion);
                    }
                    currentQuestion = {
                        question: line.replace(/^\d+[\.\)]\s*/, ''),
                        options: [],
                        correctAnswer: -1
                    };
                } else if (currentQuestion) {
                    const isCorrect = line.includes('#');
                    // Birinchi '#' ni tozalaymiz
                    let cleanOption = line.replace('#', '').trim();

                    // YANGI O'ZGARISH: A), B), 1. kabi variant belgilarini olib tashlash
                    // Regex: Qator boshidagi harf/raqam + nuqta yoki qavs + bo'sh joyni olib tashlaydi
                    cleanOption = cleanOption.replace(/^[A-Za-z0-9]+[\.\)]\s*/, '');

                    if (cleanOption) {
                        if (isCorrect) {
                            currentQuestion.correctAnswer = currentQuestion.options.length;
                        }
                        currentQuestion.options.push(cleanOption);
                    }
                }
            });

            if (currentQuestion && currentQuestion.options.length > 0) {
                questions.push(currentQuestion);
            }

            return questions.filter(q => q.options.length >= 2 && q.correctAnswer >= 0);
        }

        // Handle file upload
        async function handleFileUpload(event, sectionName, sectionPassword) {
            const file = event.target.files[0];
            if (!file) return;

            if (!sectionName || !sectionName.trim()) {
                alert('Iltimos, bo\'lim nomini kiriting!');
                return;
            }

            if (!sectionPassword || !sectionPassword.trim()) {
                alert('Iltimos, bo\'lim uchun parol kiriting!');
                return;
            }

            try {
                let text = '';
                if (file.name.endsWith('.pdf')) {
                    text = await parsePdfContent(file);
                } else if (file.name.endsWith('.docx')) {
                    text = await parseDocxContent(file);
                } else {
                    alert('Faqat PDF yoki DOCX fayllarni yuklash mumkin!');
                    return;
                }

                const questions = parseQuestions(text);

                if (questions.length === 0) {
                    alert('Faylda savollar topilmadi! Fayl formatini tekshiring:\n1. Savol\nA) Javob\n#B) To\'g\'ri javob');
                    return;
                }

                state.tempUploadedQuestions = {
                    sectionName: sectionName.trim(),
                    sectionPassword: sectionPassword.trim(),
                    questions: questions
                };

                alert(`${questions.length} ta savol yuklandi! Endi "Saqlash" tugmasini bosing.`);
                render();
            } catch (error) {
                console.error('File parsing error:', error);
                alert('Faylni o\'qishda xatolik!');
            }
        }

        // Save uploaded questions
        function saveUploadedQuestions() {
            if (!state.tempUploadedQuestions) {
                alert('Avval faylni yuklang!');
                return;
            }

            const { sectionName, sectionPassword, questions } = state.tempUploadedQuestions;

            const subsections = [];
            for (let i = 0; i < questions.length; i += 50) {
                subsections.push({
                    id: Date.now() + i,
                    name: `Qism ${Math.floor(i / 50) + 1}`,
                    questions: questions.slice(i, i + 50)
                });
            }

            const newSection = {
                id: Date.now(),
                name: sectionName,
                password: sectionPassword,
                subsections: subsections
            };

            state.sections.push(newSection);
            saveData();

            state.tempUploadedQuestions = null;

            const nameInput = document.getElementById('newSectionName');
            const passInput = document.getElementById('sectionPassword');
            const fileInput = document.getElementById('fileInput');

            if(nameInput) nameInput.value = '';
            if(passInput) passInput.value = '';
            if(fileInput) fileInput.value = '';

            alert(`Savollar muvaffaqiyatli saqlandi! (${subsections.length} ta qismga bo'lingan)`);
            render();
        }

        // Show manual entry form
        function showManualEntryForm() {
            state.showManualEntry = true;
            render();
        }

        // Hide manual entry form
        function hideManualEntryForm() {
            state.showManualEntry = false;
            render();
        }

        // Save manually entered question
        function saveManualQuestion() {
            const sectionName = document.getElementById('manualSectionName').value.trim();
            const sectionPassword = document.getElementById('manualSectionPassword').value.trim();
            const subsectionName = document.getElementById('manualSubsectionName').value.trim();
            const questionText = document.getElementById('manualQuestion').value.trim();
            const option1 = document.getElementById('manualOption1').value.trim();
            const option2 = document.getElementById('manualOption2').value.trim();
            const option3 = document.getElementById('manualOption3').value.trim();
            const option4 = document.getElementById('manualOption4').value.trim();
            const correctAnswer = parseInt(document.getElementById('manualCorrectAnswer').value);

            if (!sectionName || !subsectionName || !questionText) {
                alert('Bo\'lim nomi, qism nomi va savol matnini kiriting!');
                return;
            }

            if (!sectionPassword) {
                alert('Bo\'lim uchun parol kiriting!');
                return;
            }

            const options = [option1, option2, option3, option4].filter(opt => opt);

            if (options.length < 2) {
                alert('Kamida 2 ta variant bo\'lishi kerak!');
                return;
            }

            if (correctAnswer < 0 || correctAnswer >= options.length) {
                alert('To\'g\'ri javobni tanlang!');
                return;
            }

            let section = state.sections.find(s => s.name === sectionName);
            if (!section) {
                section = {
                    id: Date.now(),
                    name: sectionName,
                    password: sectionPassword,
                    subsections: []
                };
                state.sections.push(section);
            }

            let subsection = section.subsections.find(s => s.name === subsectionName);
            if (!subsection) {
                subsection = {
                    id: Date.now(),
                    name: subsectionName,
                    questions: []
                };
                section.subsections.push(subsection);
            }

            const newQuestion = {
                question: questionText,
                options: options,
                correctAnswer: correctAnswer
            };

            subsection.questions.push(newQuestion);
            saveData();

            alert('Savol muvaffaqiyatli qo\'shildi!');
            render();
        }

        // Toggle subsection expansion
        function toggleSubsection(sectionId, subsectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;

            const key = `${sectionId}-${subsectionId}`;
            if (state.expandedSubsections[key]) {
                delete state.expandedSubsections[key];
            } else {
                state.expandedSubsections[key] = true;
            }
            render();
        }

        // Show add question form at bottom
        function showAddQuestionForm(sectionId, subsectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;

            state.addingQuestionTo = { sectionId, subsectionId };
            render();
        }

        // Cancel adding question
        function cancelAddQuestion() {
            state.addingQuestionTo = null;
            render();
        }

        // Save new question at bottom
        function saveNewQuestionAtBottom() {
            const questionText = document.getElementById('new-question-text').value.trim();
            const option1 = document.getElementById('new-option-0').value.trim();
            const option2 = document.getElementById('new-option-1').value.trim();
            const option3 = document.getElementById('new-option-2').value.trim();
            const option4 = document.getElementById('new-option-3').value.trim();
            const correctAnswer = parseInt(document.getElementById('new-correct-answer').value);

            const options = [option1, option2, option3, option4].filter(opt => opt);

            if (!questionText || options.length < 2) {
                alert('Savol va kamida 2 ta variant bo\'lishi kerak!');
                return;
            }

            const section = state.sections.find(s => s.id === state.addingQuestionTo.sectionId);
            const subsection = section.subsections.find(s => s.id === state.addingQuestionTo.subsectionId);

            const newQuestion = {
                question: questionText,
                options: options,
                correctAnswer: correctAnswer
            };

            subsection.questions.push(newQuestion);
            saveData();

            state.addingQuestionTo = null;
            alert('Savol muvaffaqiyatli qo\'shildi!');
            render();
        }

        // Check section password
        function checkSectionPassword(sectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;

            const section = state.sections.find(s => s.id === sectionId);
            if (!section) {
                alert('Bo\'lim topilmadi!');
                return;
            }

            const password = prompt(`"${section.name}" bo'limi uchun parolni kiriting:`);

            if (password === null) {
                return;
            }

            if (password === section.password) {
                state.userSectionPassword = sectionId;
                state.currentSection = section;
                render();
            } else {
                alert('Noto\'g\'ri parol!');
            }
        }

        // Start quiz
        function startQuiz(sectionId, subsectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;

            const section = state.sections.find(s => s.id === sectionId);
            const subsection = section.subsections.find(s => s.id === subsectionId);

            state.shuffledQuestions = shuffleQuestions(subsection.questions);

            state.currentSection = section;
            state.currentSubsection = { ...subsection, questions: state.shuffledQuestions };
            state.currentQuestionIndex = 0;
            state.userAnswers = new Array(state.shuffledQuestions.length).fill(null);
            state.quizResults = null;
            state.currentScreen = 'quiz';
            startTimer();
            render();
        }

        // Navigate to question
        function goToQuestion(index) {
            if (index >= 0 && index < state.currentSubsection.questions.length) {
                state.currentQuestionIndex = index;
                state.showingFeedback = false;
                render();
            }
        }

        // Handle answer
        function handleAnswer(optionIndex) {
            if (state.showingFeedback) return;

            const currentQuestion = state.currentSubsection.questions[state.currentQuestionIndex];
            const isCorrect = optionIndex === currentQuestion.correctAnswer;

            state.userAnswers[state.currentQuestionIndex] = optionIndex;
            state.showingFeedback = true;

            const buttons = document.querySelectorAll('.answer-button');
            buttons.forEach((btn, idx) => {
                btn.disabled = true;
                if (idx === currentQuestion.correctAnswer) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-green-500', 'bg-green-50', 'pulse-green');
                } else if (idx === optionIndex && !isCorrect) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-red-500', 'bg-red-50', 'shake');
                }
            });

            setTimeout(() => {
                state.showingFeedback = false;
                if (state.currentQuestionIndex < state.currentSubsection.questions.length - 1) {
                    state.currentQuestionIndex++;
                    render();
                } else {
                    finishQuiz();
                }
            }, 400);
        }

        // Finish quiz
        function finishQuiz() {
            stopTimer();
            const questions = state.currentSubsection.questions;
            let correctCount = 0;
            const detailedResults = questions.map((q, i) => {
                const isCorrect = state.userAnswers[i] === q.correctAnswer;
                if (isCorrect) correctCount++;
                return {
                    question: q.question,
                    userAnswer: state.userAnswers[i] !== null ? q.options[state.userAnswers[i]] : 'Javob berilmagan',
                    correctAnswer: q.options[q.correctAnswer],
                    isCorrect
                };
            });

            const results = {
                total: questions.length,
                correct: correctCount,
                incorrect: questions.length - correctCount,
                percentage: ((correctCount / questions.length) * 100).toFixed(1),
                details: detailedResults,
                timeSpent: state.elapsedTime
            };

            state.quizResults = results;

            const stat = {
                username: state.currentUser.username,
                telegramNick: state.currentUser.telegramNick,
                section: state.currentSection.name,
                sectionId: state.currentSection.id,
                subsection: state.currentSubsection.name,
                date: new Date().toISOString(),
                score: results.percentage,
                correct: correctCount,
                total: questions.length,
                timeSpent: state.elapsedTime
            };

            state.allUsersStats.push(stat);
            saveData();
            state.currentScreen = 'results';
            render();
        }

        // Return to main menu
        function returnToMain() {
            stopTimer();
            state.currentSection = null;
            state.currentSubsection = null;
            state.userSectionPassword = null;
            state.currentScreen = 'main';
            render();
        }

        // Close stats
        function closeStats() {
            state.currentScreen = 'main';
            render();
        }

        // Show stats
        function showStats() {
            if (!state.currentSection) {
                alert('Avval bo\'limni tanlang!');
                return;
            }

            state.currentScreen = 'stats';
            render();
        }

        // Telegram Auto Login
        function checkTelegramAuth() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();

                const user = tg.initDataUnsafe?.user;

                if (user) {
                    const telegramNick = user.username ? `@${user.username}` : `tg_${user.id}`;

                    if (isUserBlocked(telegramNick)) {
                        alert('Sizning hisobingiz bloklangan. Admin bilan bog\'laning: @zokirov_0712');
                        return false;
                    }

                    const username = user.first_name + (user.last_name ? ' ' + user.last_name : '');

                    state.currentUser = { username, telegramNick };
                    state.isTelegramUser = true;
                    state.currentScreen = 'main';
                    render();
                    return true;
                }
            }
            return false;
        }

        // Delete question
        function deleteQuestion(sectionId, subsectionId, questionIndex) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;
            questionIndex = typeof questionIndex === 'string' ? parseInt(questionIndex) : questionIndex;

            if (confirm('Ushbu savolni o\'chirib tashlamoqchimisiz?')) {
                const section = state.sections.find(s => s.id === sectionId);
                const subsection = section.subsections.find(sub => sub.id === subsectionId);
                subsection.questions.splice(questionIndex, 1);
                saveData();
                render();
            }
        }

        // Delete section
        function deleteSection(sectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;

            if (confirm('Ushbu bo\'limni o\'chirmoqchimisiz? Barcha savollar o\'chib ketadi.')) {
                state.sections = state.sections.filter(s => s.id !== sectionId);
                state.allUsersStats = state.allUsersStats.filter(s => s.sectionId !== sectionId);
                saveData();
                render();
            }
        }

        // Change section password
        function changeSectionPassword(sectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;

            const section = state.sections.find(s => s.id === sectionId);
            if (!section) {
                alert('Bo\'lim topilmadi!');
                return;
            }

            const oldPassword = prompt(`"${section.name}" uchun hozirgi parolni kiriting:`);

            if (oldPassword === null) {
                return;
            }

            if (oldPassword !== section.password) {
                alert('Noto\'g\'ri parol!');
                return;
            }

            const newPassword = prompt('Yangi parolni kiriting:');

            if (newPassword === null || newPassword.trim() === '') {
                alert('Parol bo\'sh bo\'lishi mumkin emas!');
                return;
            }

            const confirmPassword = prompt('Yangi parolni qayta kiriting:');

            if (confirmPassword !== newPassword) {
                alert('Parollar mos kelmadi!');
                return;
            }

            section.password = newPassword.trim();
            saveData();
            alert('Parol muvaffaqiyatli o\'zgartirildi!');
            render();
        }

        // Edit question
        function editQuestion(sectionId, subsectionId, questionIndex) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;
            questionIndex = typeof questionIndex === 'string' ? parseInt(questionIndex) : questionIndex;

            state.editingQuestion = { sectionId, subsectionId, questionIndex };
            render();
        }

        function saveQuestion(sectionId, subsectionId, questionIndex) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            subsectionId = typeof subsectionId === 'string' ? parseInt(subsectionId) : subsectionId;
            questionIndex = typeof questionIndex === 'string' ? parseInt(questionIndex) : questionIndex;

            const section = state.sections.find(s => s.id === sectionId);
            const subsection = section.subsections.find(s => s.id === subsectionId);
            const question = subsection.questions[questionIndex];

            const questionText = document.getElementById('edit-question-text').value;
            const correctAnswer = parseInt(document.getElementById('edit-correct-answer').value);
            const options = [
                document.getElementById('edit-option-0').value,
                document.getElementById('edit-option-1').value,
                document.getElementById('edit-option-2').value,
                document.getElementById('edit-option-3').value
            ].filter(opt => opt && opt.trim());

            if (!questionText.trim() || options.length < 2) {
                alert('Savol va kamida 2 ta variant bo\'lishi kerak!');
                return;
            }

            question.question = questionText.trim();
            question.options = options;
            question.correctAnswer = correctAnswer;

            state.editingQuestion = null;
            saveData();
            render();
        }

        function cancelEdit() {
            state.editingQuestion = null;
            render();
        }

        // Toggle user stats
        function toggleUserStats(username) {
            if (state.expandedUserStats[username]) {
                delete state.expandedUserStats[username];
            } else {
                state.expandedUserStats[username] = true;
            }
            render();
        }

        // --- Event Handlers (Explicitly defined for global scope) ---

        function handleUserLogin() {
            const telegramNick = document.getElementById('telegramNick').value.trim();
            const username = document.getElementById('username').value.trim();

            if (!telegramNick || !username) {
                alert('Iltimos, barcha maydonlarni to\'ldiring!');
                return;
            }

            if (!telegramNick.startsWith('@')) {
                alert('Telegram nick @ belgisi bilan boshlanishi kerak!');
                return;
            }

            if (isUserBlocked(telegramNick)) {
                alert('Sizning hisobingiz bloklangan. Admin bilan bog\'laning: @zokirov_0712');
                return;
            }

            const existingUser = state.allUsersStats.find(s => s.telegramNick === telegramNick);

            if (!existingUser && state.allUsersStats.length > 0) {
                const confirmMessage = `"${telegramNick}" nickli foydalanuvchi tizimda topilmadi.\n\n` +
                    `Agar siz haqiqatan ham ushbu Telegram nickka egasiz, @zokirov_0712 ga murojaat qiling va tasdiqdan o'ting.\n\n` +
                    `Tasdiqlangandan keyin qayta urinib ko'ring.`;
                alert(confirmMessage);
                return;
            }

            state.currentUser = { username, telegramNick };
            state.currentScreen = 'main';
            render();
        }

        function handleAdminLogin() {
            const password = document.getElementById('adminPassword').value;

            if (password === 'zokirov0712') {
                state.isAdmin = true;
                state.currentScreen = 'admin';
                render();
            } else {
                alert('Noto\'g\'ri parol!');
            }
        }

        function handleLogout() {
            stopTimer();
            state.currentUser = null;
            state.isAdmin = false;
            state.currentScreen = 'login';
            state.userSectionPassword = null;
            state.currentSection = null;
            state.expandedUserStats = {};
            render();
        }

        function toggleAdminView() {
            const filesDiv = document.getElementById('adminFiles');
            const statsDiv = document.getElementById('adminStats');
            const btn = document.getElementById('toggleStatsBtn');

            if (filesDiv.classList.contains('hidden')) {
                filesDiv.classList.remove('hidden');
                statsDiv.classList.add('hidden');
                btn.innerHTML = `<div class="w-5 h-5">${icons.barChart}</div> Statistika`;
            } else {
                filesDiv.classList.add('hidden');
                statsDiv.classList.remove('hidden');
                btn.innerHTML = `<div class="w-5 h-5">${icons.fileText}</div> Fayllar`;
            }
        }

        function toggleSectionEdit(sectionId) {
            sectionId = typeof sectionId === 'string' ? parseInt(sectionId) : sectionId;
            const editDiv = document.getElementById(`section-edit-${sectionId}`);
            if(editDiv) editDiv.classList.toggle('hidden');
        }

        function handleFileUploadWrapper(event) {
            const sectionName = document.getElementById('newSectionName').value;
            const sectionPassword = document.getElementById('sectionPassword').value;
            handleFileUpload(event, sectionName, sectionPassword);
        }

        function addNewUser() {
            const telegramNick = document.getElementById('newUserTelegramNick').value.trim();
            const userName = document.getElementById('newUserName').value.trim();

            if (!telegramNick || !userName) {
                alert('Iltimos, barcha maydonlarni to\'ldiring!');
                return;
            }

            if (!telegramNick.startsWith('@')) {
                alert('Telegram nick @ belgisi bilan boshlanishi kerak!');
                return;
            }

            const existingUser = state.allUsersStats.find(s => s.telegramNick === telegramNick);
            if (existingUser) {
                alert('Ushbu Telegram nick allaqachon ro\'yxatdan o\'tgan!');
                return;
            }

            const newUserStat = {
                username: userName,
                telegramNick: telegramNick,
                section: 'Ro\'yxatga olish',
                sectionId: 0,
                subsection: 'Yangi foydalanuvchi',
                date: new Date().toISOString(),
                score: 0,
                correct: 0,
                total: 0,
                timeSpent: 0
            };

            state.allUsersStats.push(newUserStat);
            saveData();

            alert(`${userName} (${telegramNick}) muvaffaqiyatli ro'yxatga olindi!`);

            document.getElementById('newUserTelegramNick').value = '';
            document.getElementById('newUserName').value = '';

            render();
        }

        // --- Render Functions (Strings) ---

        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center p-4">
                    <div class="absolute inset-0 opacity-20" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAxMCAwIEwgMCAwIDAgMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjAzKSIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIi8+PC9zdmc+');"></div>

                    <div class="relative bg-white/10 backdrop-blur-xl p-10 rounded-3xl shadow-2xl max-w-md w-full border border-white/20">
                        <div class="text-center mb-8">
                            <div class="inline-block p-4 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full mb-4">
                                <div class="w-12 h-12 text-white">${icons.award}</div>
                            </div>
                            <h1 class="text-4xl font-bold text-white mb-2">Quiz Tizimi</h1>
                            <p class="text-white/70">Bilimingizni sinab ko'ring</p>
                        </div>

                        <div class="space-y-6">
                            <div class="space-y-4">
                                <h2 class="text-xl font-semibold text-white">Telegram orqali kirish (Tavsiya etiladi)</h2>
                                <p class="text-sm text-white/70">âœ… Avtomatik kirish, tekshirish shart emas</p>
                                <a
                                    href="https://t.me/zokirov_0712_bot"
                                    target="_blank"
                                    class="block w-full bg-gradient-to-r from-blue-400 to-blue-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition text-center"
                                >
                                    <div class="flex items-center justify-center gap-2">
                                        <div class="w-6 h-6">${icons.send}</div>
                                        <span>Telegram orqali kirish</span>
                                    </div>
                                </a>
                            </div>

                            <div class="border-t border-white/20 pt-6 space-y-4">
                                <h2 class="text-xl font-semibold text-white">Qo'lda kirish</h2>
                                <p class="text-sm text-white/70">âš ï¸ Faqat tizimda ro'yxatdan o'tgan foydalanuvchilar</p>
                                <input
                                    type="text"
                                    id="telegramNick"
                                    placeholder="Telegram Nick (@username)"
                                    class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition"
                                />
                                <input
                                    type="text"
                                    id="username"
                                    placeholder="Ismingiz"
                                    class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition"
                                />
                                <button
                                    onclick="handleUserLogin()"
                                    class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 rounded-xl font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition"
                                >
                                    Kirish
                                </button>
                                <p class="text-xs text-white/60 text-center">
                                    Yangi foydalanuvchi bo'lsangiz, @zokirov_0712 ga murojaat qiling
                                </p>
                            </div>

                            <div class="border-t border-white/20 pt-6 space-y-4">
                                <h2 class="text-xl font-semibold text-white">Admin kirish</h2>
                                <input
                                    type="password"
                                    id="adminPassword"
                                    placeholder="Admin paroli"
                                    class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-xl text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-400 transition"
                                />
                                <button
                                    onclick="handleAdminLogin()"
                                    class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-xl font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition"
                                >
                                    Admin sifatida kirish
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 text-center">
                            <a href="https://t.me/zokirov_0712" target="_blank" class="text-white/70 hover:text-white text-sm flex items-center justify-center gap-2">
                                <div class="w-4 h-4">${icons.send}</div>
                                Murojaat uchun: @zokirov_0712
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainMenu() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div class="container mx-auto p-6">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Xush kelibsiz, ${state.currentUser.username}!</h1>
                                    <p class="text-gray-500">${state.currentUser.telegramNick}</p>
                                </div>
                                <div class="flex gap-3">
                                    ${state.currentSection ? `
                                        <button
                                            onclick="showStats()"
                                            class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                        >
                                            <div class="w-5 h-5">${icons.barChart}</div>
                                            Statistika
                                        </button>
                                    ` : ''}
                                    <button
                                        onclick="handleLogout()"
                                        class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                    >
                                        <div class="w-5 h-5">${icons.logout}</div>
                                        Chiqish
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${state.sections.map(section => `
                                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-2xl transition transform hover:-translate-y-1">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg">
                                                <div class="w-6 h-6 text-white">${icons.fileText}</div>
                                            </div>
                                            <div>
                                                <h3 class="text-xl font-bold text-gray-800">${section.name}</h3>
                                                <p class="text-sm text-gray-500">${section.subsections.length} ta qism</p>
                                            </div>
                                        </div>
                                        <div class="p-2 bg-yellow-100 rounded-lg">
                                            <div class="w-5 h-5 text-yellow-600">${icons.lock}</div>
                                        </div>
                                    </div>

                                    ${state.userSectionPassword === section.id ? `
                                        <div class="space-y-2 mt-4">
                                            ${section.subsections.map(subsection => `
                                                <button
                                                    onclick="startQuiz(${section.id}, ${subsection.id})"
                                                    class="w-full text-left px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg hover:from-indigo-100 hover:to-purple-100 transition group"
                                                >
                                                    <div class="flex justify-between items-center">
                                                        <span class="font-medium text-gray-700 group-hover:text-indigo-600 transition">
                                                            ${subsection.name}
                                                        </span>
                                                        <span class="text-sm text-gray-500">
                                                            ${subsection.questions.length} savol
                                                        </span>
                                                    </div>
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <button
                                            onclick="checkSectionPassword(${section.id})"
                                            class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition flex items-center justify-center gap-2"
                                        >
                                            <div class="w-5 h-5">${icons.lock}</div>
                                            Parol kiritish
                                        </button>
                                    `}
                                </div>
                            `).join('')}
                        </div>

                        ${state.sections.length === 0 ? `
                            <div class="text-center py-20">
                                <div class="w-20 h-20 text-gray-300 mx-auto mb-4">${icons.fileText}</div>
                                <p class="text-gray-500 text-lg">Hozircha testlar mavjud emas</p>
                                <p class="text-gray-400">Admin savollarni yuklashi kerak</p>
                            </div>
                        ` : ''}

                        <div class="mt-8 text-center">
                            <a href="https://t.me/zokirov_0712" target="_blank" class="text-gray-500 hover:text-gray-700 text-sm flex items-center justify-center gap-2">
                                <div class="w-4 h-4">${icons.send}</div>
                                Murojaat uchun: @zokirov_0712
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuiz() {
            const currentQuestion = state.currentSubsection.questions[state.currentQuestionIndex];
            const progress = ((state.currentQuestionIndex + 1) / state.currentSubsection.questions.length) * 100;
            const hasPrevious = state.currentQuestionIndex > 0;
            const hasNext = state.currentQuestionIndex < state.currentSubsection.questions.length - 1;

            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
                    <div class="container mx-auto max-w-4xl">
                        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden fade-in">
                            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">${state.currentSection.name}</h2>
                                    <div class="flex items-center gap-4">
                                        <div class="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full">
                                            <div class="w-5 h-5">${icons.clock}</div>
                                            <span id="timer" class="font-mono font-bold">00:00</span>
                                        </div>
                                        <span class="bg-white/20 px-4 py-2 rounded-full text-sm font-semibold">
                                            ${state.currentQuestionIndex + 1} / ${state.currentSubsection.questions.length}
                                        </span>
                                    </div>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2">
                                    <div class="bg-white rounded-full h-2 transition-all duration-500" style="width: ${progress}%"></div>
                                </div>
                            </div>

                            <div class="p-8">
                                <h3 class="text-2xl font-bold text-gray-800 mb-8">
                                    ${currentQuestion.question}
                                </h3>

                                <div class="space-y-4 mb-8">
                                    ${currentQuestion.options.map((option, index) => `
                                        <button
                                            onclick="handleAnswer(${index})"
                                            class="answer-button w-full text-left p-5 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl hover:from-purple-50 hover:to-pink-50 border-2 border-gray-200 hover:border-purple-400 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg"
                                        >
                                            <div class="flex items-start gap-4">
                                                <div class="flex-shrink-0 w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold">
                                                    ${String.fromCharCode(65 + index)}
                                                </div>
                                                <span class="text-lg text-gray-700 flex-1">${option}</span>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>

                                <div class="flex gap-3">
                                    <button
                                        onclick="returnToMain()"
                                        class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition"
                                    >
                                        <div class="w-5 h-5">${icons.home}</div>
                                        Bosh menyu
                                    </button>

                                    <button
                                        onclick="goToQuestion(${state.currentQuestionIndex - 1})"
                                        ${!hasPrevious ? 'disabled' : ''}
                                        class="flex-1 flex items-center justify-center gap-2 px-4 py-3 ${hasPrevious ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-300 cursor-not-allowed'} text-white rounded-xl transition"
                                    >
                                        <div class="w-5 h-5">${icons.arrowLeft}</div>
                                        Oldingi
                                    </button>

                                    <button
                                        onclick="goToQuestion(${state.currentQuestionIndex + 1})"
                                        ${!hasNext ? 'disabled' : ''}
                                        class="flex-1 flex items-center justify-center gap-2 px-4 py-3 ${hasNext ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-300 cursor-not-allowed'} text-white rounded-xl transition"
                                    >
                                        Keyingi
                                        <div class="w-5 h-5">${icons.arrowRight}</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const isPassed = state.quizResults.percentage >= 70;

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div class="container mx-auto max-w-4xl">
                        <div class="bg-white rounded-2xl shadow-2xl p-8">
                            <div class="text-center mb-8">
                                <div class="inline-block p-6 rounded-full mb-4 ${isPassed ? 'bg-green-100' : 'bg-red-100'}">
                                    <div class="w-20 h-20 ${isPassed ? 'text-green-600' : 'text-red-600'}">
                                        ${isPassed ? icons.checkCircle : icons.xCircle}
                                    </div>
                                </div>
                                <h1 class="text-4xl font-bold text-gray-800 mb-2">
                                    ${isPassed ? 'Tabriklaymiz!' : 'Qayta urinib ko\'ring!'}
                                </h1>
                                <p class="text-xl text-gray-600">Sizning natijangiz</p>
                                <div class="flex items-center justify-center gap-2 mt-3 text-gray-500">
                                    <div class="w-5 h-5">${icons.clock}</div>
                                    <span>Vaqt: ${formatTime(state.quizResults.timeSpent)}</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-8">
                                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white text-center">
                                    <div class="text-4xl font-bold mb-2">${state.quizResults.total}</div>
                                    <div class="text-blue-100">Jami savollar</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white text-center">
                                    <div class="text-4xl font-bold mb-2">${state.quizResults.correct}</div>
                                    <div class="text-green-100">To'g'ri javoblar</div>
                                </div>
                                <div class="bg-gradient-to-br ${isPassed ? 'from-yellow-500 to-orange-500' : 'from-red-500 to-red-600'} rounded-xl p-6 text-white text-center">
                                    <div class="text-4xl font-bold mb-2">${state.quizResults.percentage}%</div>
                                    <div class="${isPassed ? 'text-yellow-100' : 'text-red-100'}">Ball</div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <div class="w-6 h-6">${icons.barChart}</div>
                                    Test tahlili
                                </h2>
                                <div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${state.quizResults.details.map((detail, index) => `
                                        <div class="p-4 rounded-lg border-l-4 ${detail.isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}">
                                            <div class="flex items-start gap-3">
                                                <div class="w-5 h-5 ${detail.isCorrect ? 'text-green-600' : 'text-red-600'} flex-shrink-0 mt-1">
                                                    ${detail.isCorrect ? icons.checkCircle : icons.xCircle}
                                                </div>
                                                <div class="flex-1">
                                                    <p class="font-semibold text-gray-800 mb-2">
                                                        ${index + 1}. ${detail.question}
                                                    </p>
                                                    <div class="text-sm space-y-1">
                                                        <p class="text-gray-600">
                                                            <span class="font-medium">Sizning javobingiz:</span> ${detail.userAnswer}
                                                        </p>
                                                        ${!detail.isCorrect ? `
                                                            <p class="text-green-700">
                                                                <span class="font-medium">To'g'ri javob:</span> ${detail.correctAnswer}
                                                            </p>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button
                                    onclick="returnToMain()"
                                    class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-semibold hover:shadow-lg transform hover:-translate-y-0.5 transition flex items-center justify-center gap-2"
                                >
                                    <div class="w-5 h-5">${icons.arrowLeft}</div>
                                    Bosh menyu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin() {
            const todayStats = state.allUsersStats.filter(stat => {
                const today = new Date().toDateString();
                return new Date(stat.date).toDateString() === today;
            });

            return `
                <div class="min-h-screen bg-gradient-to-br from-gray-900 to-purple-900 p-6">
                    <div class="container mx-auto max-w-6xl">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                    <div class="p-3 bg-purple-600 rounded-lg">
                                        <div class="w-8 h-8 text-white">${icons.users}</div>
                                    </div>
                                    Admin Panel
                                </h1>
                                <div class="flex gap-3">
                                    <button
                                        onclick="toggleAdminView()"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                                        id="toggleStatsBtn"
                                    >
                                        <div class="w-5 h-5">${icons.barChart}</div>
                                        Statistika
                                    </button>
                                    <button
                                        onclick="handleLogout()"
                                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2"
                                    >
                                        <div class="w-5 h-5">${icons.logout}</div>
                                        Chiqish
                                    </button>
                                </div>
                            </div>

                            <div id="adminFiles">
                                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 mb-6 border-2 border-green-300">
                                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <div class="w-6 h-6">${icons.users}</div>
                                        Yangi foydalanuvchi qo'shish
                                    </h2>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <input
                                            type="text"
                                            id="newUserTelegramNick"
                                            placeholder="Telegram nick (@username)"
                                            class="px-4 py-3 border-2 border-green-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                                        />
                                        <input
                                            type="text"
                                            id="newUserName"
                                            placeholder="Foydalanuvchi ismi"
                                            class="px-4 py-3 border-2 border-green-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500"
                                        />
                                    </div>
                                    <button
                                        onclick="addNewUser()"
                                        class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2"
                                    >
                                        <div class="w-5 h-5">${icons.plus}</div>
                                        Foydalanuvchini ro'yxatga olish
                                    </button>
                                    <p class="text-sm text-gray-600 mt-3">
                                        * Foydalanuvchi qo'shilgandan keyin, u o'z Telegram nickini ishlatib tizimga kirishga ruxsat oladi.
                                    </p>
                                </div>

                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6">
                                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <div class="w-6 h-6">${icons.upload}</div>
                                        Yangi test yuklash
                                    </h2>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <input
                                            type="text"
                                            id="newSectionName"
                                            placeholder="Bo'lim nomi (majburiy)"
                                            class="px-4 py-3 border-2 border-purple-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        />
                                        <input
                                            type="password"
                                            id="sectionPassword"
                                            placeholder="Bo'lim paroli (majburiy)"
                                            class="px-4 py-3 border-2 border-purple-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        />
                                    </div>
                                    <div class="flex gap-4 mb-4">
                                        <label class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold cursor-pointer hover:shadow-lg transition flex items-center justify-center gap-2">
                                            <div class="w-5 h-5">${icons.upload}</div>
                                            Fayl tanlash
                                            <input
                                                type="file"
                                                id="fileInput"
                                                accept=".pdf,.docx"
                                                onchange="handleFileUploadWrapper(event)"
                                                class="hidden"
                                            />
                                        </label>
                                    </div>

                                    ${state.tempUploadedQuestions ? `
                                        <div class="bg-green-100 border-2 border-green-400 rounded-lg p-4 mb-4">
                                            <p class="text-green-800 font-semibold mb-2">
                                                âœ“ ${state.tempUploadedQuestions.questions.length} ta savol yuklandi!
                                            </p>
                                            <p class="text-green-700 text-sm mb-3">
                                                Bo'lim: ${state.tempUploadedQuestions.sectionName}
                                            </p>
                                            <button
                                                onclick="saveUploadedQuestions()"
                                                class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2"
                                            >
                                                <div class="w-5 h-5">${icons.save}</div>
                                                Saqlash
                                            </button>
                                        </div>
                                    ` : ''}

                                    <div class="flex gap-3">
                                        <button
                                            onclick="showManualEntryForm()"
                                            class="flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2"
                                        >
                                            <div class="w-5 h-5">${icons.pencil}</div>
                                            Qo'lda yozish
                                        </button>
                                    </div>
                                </div>

                                ${state.showManualEntry ? `
                                    <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-6 mb-6 border-2 border-orange-300">
                                        <div class="flex justify-between items-center mb-4">
                                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                                <div class="w-6 h-6">${icons.pencil}</div>
                                                Savol qo'lda kiritish
                                            </h2>
                                            <button
                                                onclick="hideManualEntryForm()"
                                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                                            >
                                                Yopish
                                            </button>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="grid grid-cols-3 gap-4">
                                                <input
                                                    type="text"
                                                    id="manualSectionName"
                                                    placeholder="Bo'lim nomi"
                                                    class="px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="password"
                                                    id="manualSectionPassword"
                                                    placeholder="Bo'lim paroli"
                                                    class="px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="text"
                                                    id="manualSubsectionName"
                                                    placeholder="Qism nomi"
                                                    class="px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                            </div>

                                            <textarea
                                                id="manualQuestion"
                                                placeholder="Savol matni"
                                                rows="3"
                                                class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                            ></textarea>

                                            <div class="space-y-2">
                                                <p class="font-semibold text-gray-700">Javob variantlari:</p>
                                                <input
                                                    type="text"
                                                    id="manualOption1"
                                                    placeholder="Variant 1"
                                                    class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="text"
                                                    id="manualOption2"
                                                    placeholder="Variant 2"
                                                    class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="text"
                                                    id="manualOption3"
                                                    placeholder="Variant 3 (ixtiyoriy)"
                                                    class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                                <input
                                                    type="text"
                                                    id="manualOption4"
                                                    placeholder="Variant 4 (ixtiyoriy)"
                                                    class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                />
                                            </div>

                                            <div>
                                                <label class="block font-semibold text-gray-700 mb-2">To'g'ri javob:</label>
                                                <select
                                                    id="manualCorrectAnswer"
                                                    class="w-full px-4 py-3 border-2 border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                >
                                                    <option value="0">Variant 1</option>
                                                    <option value="1">Variant 2</option>
                                                    <option value="2">Variant 3</option>
                                                    <option value="3">Variant 4</option>
                                                </select>
                                            </div>

                                            <button
                                                onclick="saveManualQuestion()"
                                                class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center gap-2"
                                            >
                                                <div class="w-5 h-5">${icons.save}</div>
                                                Savolni saqlash
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border-2 border-blue-300">
                                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <div class="w-6 h-6">${icons.users}</div>
                                        Ro'yxatga olingan foydalanuvchilar (${new Set(state.allUsersStats.map(s => s.telegramNick)).size})
                                    </h2>
                                    <div class="max-h-60 overflow-y-auto">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            ${Array.from(new Set(state.allUsersStats.map(s => s.telegramNick))).map(nick => {
                                                const user = state.allUsersStats.find(s => s.telegramNick === nick);
                                                const userStats = state.allUsersStats.filter(s => s.telegramNick === nick);
                                                const realTestsCount = userStats.filter(s => s.total > 0).length;
                                                const blocked = isUserBlocked(nick);
                                                return `
                                                    <div class="bg-white rounded-lg p-3 border ${blocked ? 'border-red-300' : 'border-blue-200'}">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <p class="font-semibold text-gray-800">${user.username}</p>
                                                                <p class="text-sm text-gray-600">${nick}</p>
                                                                <p class="text-xs ${blocked ? 'text-red-500' : 'text-gray-500'}">${blocked ? 'ðŸš« Bloklangan' : realTestsCount + ' ta test ishlagan'}</p>
                                                            </div>
                                                            <div class="flex gap-1">
                                                                ${blocked ? `
                                                                    <button
                                                                        onclick="unblockUser(\`${nick}\`)"
                                                                        class="p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                                                        title="Blokdan chiqarish"
                                                                    >
                                                                        <div class="w-4 h-4">${icons.userCheck}</div>
                                                                    </button>
                                                                ` : `
                                                                    <button
                                                                        onclick="blockUser(\`${nick}\`)"
                                                                        class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                                                        title="Bloklash"
                                                                    >
                                                                        <div class="w-4 h-4">${icons.ban}</div>
                                                                    </button>
                                                                `}
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <h2 class="text-2xl font-bold text-gray-800">Mavjud testlar</h2>
                                    ${state.sections.map(section => `
                                        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                                            <div class="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 class="text-xl font-bold text-gray-800">${section.name}</h3>
                                                    <p class="text-gray-600">${section.subsections.length} ta qism, jami ${section.subsections.reduce((sum, sub) => sum + sub.questions.length, 0)} ta savol</p>
                                                    <p class="text-sm text-gray-500 mt-1">ðŸ”’ Parol: ${section.password}</p>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button
                                                        onclick="changeSectionPassword('${section.id}')"
                                                        class="p-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
                                                        title="Parolni o'zgartirish"
                                                    >
                                                        <div class="w-5 h-5">${icons.lock}</div>
                                                    </button>
                                                    <button
                                                        onclick="toggleSectionEdit('${section.id}')"
                                                        class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                                        title="Savollarni tahrirlash"
                                                    >
                                                        <div class="w-5 h-5">${icons.edit}</div>
                                                    </button>
                                                    <button
                                                        onclick="deleteSection('${section.id}')"
                                                        class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                                        title="Bo'limni o'chirish"
                                                    >
                                                        <div class="w-5 h-5">${icons.trash}</div>
                                                    </button>
                                                </div>
                                            </div>

                                            <div id="section-edit-${section.id}" class="hidden mt-4 space-y-3 max-h-96 overflow-y-auto bg-white p-4 rounded-lg">
                                                ${section.subsections.map((subsection) => {
                                                    const subsectionKey = `${section.id}-${subsection.id}`;
                                                    const isExpanded = state.expandedSubsections[subsectionKey];

                                                    return `
                                                    <div class="border-l-4 border-purple-500 pl-4 mb-6">
                                                        <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="event.stopPropagation(); toggleSubsection(${section.id}, ${subsection.id})">
                                                            <h4 class="font-bold text-gray-700">${subsection.name} (${subsection.questions.length} savol)</h4>
                                                            <div class="w-5 h-5 text-gray-400 transform transition-transform ${isExpanded ? 'rotate-180' : ''}">
                                                                ${icons.chevronDown}
                                                            </div>
                                                        </div>

                                                        ${isExpanded ? `
                                                            <div class="mt-3 space-y-2">
                                                                ${subsection.questions.map((q, qIndex) => `
                                                                    ${state.editingQuestion &&
                                                                      state.editingQuestion.sectionId === section.id &&
                                                                      state.editingQuestion.subsectionId === subsection.id &&
                                                                      state.editingQuestion.questionIndex === qIndex ? `
                                                                        <div class="mb-3 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                                                                            <div class="space-y-3">
                                                                                <div>
                                                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Savol:</label>
                                                                                    <textarea id="edit-question-text" rows="3" class="w-full px-3 py-2 border rounded-lg">${q.question}</textarea>
                                                                                </div>
                                                                                <div>
                                                                                    <label class="block text-sm font-medium text-gray-700 mb-1">Variantlar:</label>
                                                                                    ${q.options.map((opt, oIdx) => `
                                                                                        <textarea id="edit-option-${oIdx}" rows="2" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Variant ${oIdx + 1}">${opt}</textarea>
                                                                                    `).join('')}
                                                                                </div>
                                                                                <div>
                                                                                    <label class="block text-sm font-medium text-gray-700 mb-1">To'g'ri javob:</label>
                                                                                    <select id="edit-correct-answer" class="w-full px-3 py-2 border rounded-lg">
                                                                                        ${q.options.map((opt, oIdx) => `
                                                                                            <option value="${oIdx}" ${oIdx === q.correctAnswer ? 'selected' : ''}>Variant ${oIdx + 1}</option>
                                                                                        `).join('')}
                                                                                    </select>
                                                                                </div>
                                                                                <div class="flex gap-2">
                                                                                    <button onclick="saveQuestion(${section.id}, ${subsection.id}, ${qIndex})" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                                                                        <div class="w-4 h-4">${icons.save}</div>
                                                                                        Saqlash
                                                                                    </button>
                                                                                    <button onclick="cancelEdit()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                                                                        Bekor qilish
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ` : `
                                                                        <div class="mb-3 text-sm bg-gray-50 p-3 rounded relative group">
                                                                            <div class="absolute top-2 right-2 flex gap-1">
                                                                                <button
                                                                                    onclick="editQuestion(${section.id}, ${subsection.id}, ${qIndex})"
                                                                                    class="p-1 bg-blue-500 text-white rounded opacity-0 group-hover:opacity-100 transition shadow-sm"
                                                                                    title="Tahrirlash"
                                                                                >
                                                                                    <div class="w-4 h-4">${icons.edit}</div>
                                                                                </button>
                                                                                <button
                                                                                    onclick="deleteQuestion(${section.id}, ${subsection.id}, ${qIndex})"
                                                                                    class="p-1 bg-red-500 text-white rounded opacity-0 group-hover:opacity-100 transition shadow-sm"
                                                                                    title="O'chirish"
                                                                                >
                                                                                    <div class="w-4 h-4">${icons.trash}</div>
                                                                                </button>
                                                                            </div>
                                                                            <p class="font-medium text-gray-800 pr-16 whitespace-pre-wrap">${qIndex + 1}. ${q.question}</p>
                                                                            <ul class="mt-2 space-y-1">
                                                                                ${q.options.map((opt, oIndex) => `
                                                                                    <li class="pl-4 whitespace-pre-wrap ${oIndex === q.correctAnswer ? 'text-green-600 font-semibold' : 'text-gray-600'}">
                                                                                        ${opt} ${oIndex === q.correctAnswer ? 'âœ“' : ''}
                                                                                    </li>
                                                                                `).join('')}
                                                                            </ul>
                                                                        </div>
                                                                    `}
                                                                `).join('')}

                                                                ${state.addingQuestionTo &&
                                                                  state.addingQuestionTo.sectionId === section.id &&
                                                                  state.addingQuestionTo.subsectionId === subsection.id ? `
                                                                    <div class="mb-3 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                                                                        <h5 class="font-semibold text-green-800 mb-3">Yangi savol qo'shish</h5>
                                                                        <div class="space-y-3">
                                                                            <div>
                                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Savol:</label>
                                                                                <textarea id="new-question-text" rows="3" class="w-full px-3 py-2 border rounded-lg" placeholder="Savol matnini kiriting"></textarea>
                                                                            </div>
                                                                            <div>
                                                                                <label class="block text-sm font-medium text-gray-700 mb-1">Variantlar:</label>
                                                                                <textarea id="new-option-0" rows="2" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Variant 1"></textarea>
                                                                                <textarea id="new-option-1" rows="2" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Variant 2"></textarea>
                                                                                <textarea id="new-option-2" rows="2" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Variant 3 (ixtiyoriy)"></textarea>
                                                                                <textarea id="new-option-3" rows="2" class="w-full px-3 py-2 border rounded-lg mb-2" placeholder="Variant 4 (ixtiyoriy)"></textarea>
                                                                            </div>
                                                                            <div>
                                                                                <label class="block text-sm font-medium text-gray-700 mb-1">To'g'ri javob:</label>
                                                                                <select id="new-correct-answer" class="w-full px-3 py-2 border rounded-lg">
                                                                                    <option value="0">Variant 1</option>
                                                                                    <option value="1">Variant 2</option>
                                                                                    <option value="2">Variant 3</option>
                                                                                    <option value="3">Variant 4</option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="flex gap-2">
                                                                                <button onclick="saveNewQuestionAtBottom()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                                                                                    <div class="w-4 h-4">${icons.save}</div>
                                                                                    Saqlash
                                                                                </button>
                                                                                <button onclick="cancelAddQuestion()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                                                                    Bekor qilish
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ` : `
                                                                    <button
                                                                        onclick="showAddQuestionForm(${section.id}, ${subsection.id})"
                                                                        class="w-full px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition flex items-center justify-center gap-2 border-2 border-dashed border-green-300"
                                                                    >
                                                                        <div class="w-5 h-5">${icons.plus}</div>
                                                                        Savol qo'shish
                                                                    </button>
                                                                `}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `}).join('')}
                                            </div>
                                        </div>
                                    `).join('')}

                                    ${state.sections.length === 0 ? `
                                        <div class="text-center py-12 text-gray-500">
                                            <div class="w-16 h-16 mx-auto mb-4 text-gray-300">${icons.fileText}</div>
                                            <p>Hozircha testlar mavjud emas</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div id="adminStats" class="hidden space-y-6">
                                ${renderStatsContent(todayStats, true)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatsContent(todayStats, isAdmin = false) {
            const relevantStats = state.currentSection && !isAdmin
                ? state.allUsersStats.filter(s => s.sectionId === state.currentSection.id)
                : state.allUsersStats;

            const userGroups = {};
            relevantStats.forEach(stat => {
                const key = `${stat.username}-${stat.telegramNick}`;
                if (!userGroups[key]) {
                    userGroups[key] = {
                        username: stat.username,
                        telegramNick: stat.telegramNick,
                        stats: [],
                        totalTests: 0,
                        avgScore: 0,
                        bestScore: 0,
                        totalCorrect: 0,
                        totalQuestions: 0
                    };
                }
                userGroups[key].stats.push(stat);
            });

            Object.values(userGroups).forEach(group => {
                group.totalTests = group.stats.length;
                group.avgScore = (group.stats.reduce((sum, s) => sum + parseFloat(s.score), 0) / group.totalTests).toFixed(1);
                group.bestScore = Math.max(...group.stats.map(s => parseFloat(s.score))).toFixed(1);
                group.totalCorrect = group.stats.reduce((sum, s) => sum + s.correct, 0);
                group.totalQuestions = group.stats.reduce((sum, s) => sum + s.total, 0);
                group.stats.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            const sortedUsers = Object.values(userGroups).sort((a, b) => {
                if (parseFloat(b.bestScore) !== parseFloat(a.bestScore)) {
                    return parseFloat(b.bestScore) - parseFloat(a.bestScore);
                }
                return parseFloat(b.avgScore) - parseFloat(a.avgScore);
            });

            const todayRelevantStats = todayStats.filter(s =>
                !state.currentSection || s.sectionId === state.currentSection.id
            );

            const overallCorrect = relevantStats.reduce((sum, s) => sum + s.correct, 0);
            const overallTotal = relevantStats.reduce((sum, s) => sum + s.total, 0);
            const overallPercentage = overallTotal > 0 ? ((overallCorrect / overallTotal) * 100).toFixed(1) : 0;

            return `
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 text-white mb-6">
                    <h2 class="text-2xl font-bold mb-4">
                        ${state.currentSection && !isAdmin ? `"${state.currentSection.name}" bo'limi umumiy statistikasi` : 'Bugungi statistika'}
                    </h2>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-white/20 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold">${todayRelevantStats.length}</div>
                            <div class="text-sm text-white/80">Bugun ishlangan</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold">
                                ${relevantStats.length}
                            </div>
                            <div class="text-sm text-white/80">Jami testlar</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold">
                                ${new Set(relevantStats.map(s => s.username)).size}
                            </div>
                            <div class="text-sm text-white/80">Foydalanuvchilar</div>
                        </div>
                        <div class="bg-white/20 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold">
                                ${overallPercentage}%
                            </div>
                            <div class="text-sm text-white/80">Umumiy o'rtacha</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <div class="w-6 h-6">${icons.trending}</div>
                        Foydalanuvchilar reytingi
                    </h3>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${sortedUsers.map((user, index) => {
                            const userKey = `${user.username}-${user.telegramNick}`;
                            const isExpanded = state.expandedUserStats[userKey];

                            return `
                            <div class="bg-gray-50 rounded-lg border border-gray-200 ${index < 3 ? 'border-l-4 ' + (index === 0 ? 'border-yellow-500' : index === 1 ? 'border-gray-400' : 'border-orange-600') : ''}">
                                <div class="p-4 cursor-pointer" onclick="toggleUserStats(\`${userKey}\`)">
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-gray-400'}">
                                                ${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '#' + (index + 1)}
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-800">${user.username}</p>
                                                <p class="text-sm text-gray-600">${user.telegramNick}</p>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    ${user.totalTests} ta test Â· ${user.totalCorrect}/${user.totalQuestions} to'g'ri
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold ${parseFloat(user.bestScore) >= 70 ? 'text-green-600' : 'text-red-600'}">
                                                ${user.bestScore}%
                                            </div>
                                            <p class="text-sm text-gray-600">
                                                O'rtacha: ${user.avgScore}%
                                            </p>
                                            <div class="w-5 h-5 mt-2 text-gray-400 mx-auto transform transition-transform ${isExpanded ? 'rotate-180' : ''}">
                                                ${icons.chevronDown}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                ${isExpanded ? `
                                    <div class="border-t border-gray-200 p-4 bg-white">
                                        <h4 class="font-semibold text-gray-700 mb-3">Test tarixi:</h4>
                                        <div class="space-y-2">
                                            ${user.stats.map((stat, idx) => `
                                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <p class="font-medium text-gray-800">${stat.section} - ${stat.subsection}</p>
                                                        <p class="text-xs text-gray-500">
                                                            ${formatDateTime(stat.date)}
                                                        </p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="font-bold ${parseFloat(stat.score) >= 70 ? 'text-green-600' : 'text-red-600'}">
                                                            ${stat.score}%
                                                        </p>
                                                        <p class="text-xs text-gray-600">
                                                            ${stat.correct}/${stat.total} Â· ${formatTime(stat.timeSpent)}
                                                        </p>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>

                    ${sortedUsers.length === 0 ? `
                        <div class="text-center py-12 text-gray-500">
                            <div class="w-16 h-16 mx-auto mb-4 text-gray-300">${icons.barChart}</div>
                            <p>Hozircha statistika mavjud emas</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStats() {
            const todayStats = state.allUsersStats.filter(stat => {
                const today = new Date().toDateString();
                return new Date(stat.date).toDateString() === today;
            });

            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div class="container mx-auto max-w-6xl">
                        <div class="bg-white rounded-2xl shadow-2xl p-8">
                            <div class="flex justify-between items-center mb-6">
                                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                    <div class="p-3 bg-blue-600 rounded-lg">
                                        <div class="w-8 h-8 text-white">${icons.barChart}</div>
                                    </div>
                                    ${state.currentSection ? `"${state.currentSection.name}" statistikasi` : 'Statistika'}
                                </h1>
                                <button
                                    onclick="closeStats()"
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2"
                                >
                                    <div class="w-5 h-5">${icons.arrowLeft}</div>
                                    Yopish
                                </button>
                            </div>

                            ${renderStatsContent(todayStats, false)}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            let html = '';

            switch(state.currentScreen) {
                case 'login':
                    html = renderLogin();
                    break;
                case 'main':
                    html = renderMainMenu();
                    break;
                case 'quiz':
                    html = renderQuiz();
                    break;
                case 'results':
                    html = renderResults();
                    break;
                case 'admin':
                    html = renderAdmin();
                    break;
                case 'stats':
                    html = renderStats();
                    break;
            }

            document.getElementById('app').innerHTML = html;
        }

        // Initialize Global Scope for HTML onclick events
        window.handleUserLogin = handleUserLogin;
        window.handleAdminLogin = handleAdminLogin;
        window.handleLogout = handleLogout;
        window.showStats = showStats;
        window.closeStats = closeStats;
        window.toggleAdminView = toggleAdminView;
        window.toggleSectionEdit = toggleSectionEdit;
        window.handleFileUploadWrapper = handleFileUploadWrapper;
        window.saveUploadedQuestions = saveUploadedQuestions;
        window.showManualEntryForm = showManualEntryForm;
        window.hideManualEntryForm = hideManualEntryForm;
        window.saveManualQuestion = saveManualQuestion;
        window.checkSectionPassword = checkSectionPassword;
        window.startQuiz = startQuiz;
        window.goToQuestion = goToQuestion;
        window.handleAnswer = handleAnswer;
        window.returnToMain = returnToMain;
        window.deleteQuestion = deleteQuestion;
        window.deleteSection = deleteSection;
        window.changeSectionPassword = changeSectionPassword;
        window.editQuestion = editQuestion;
        window.saveQuestion = saveQuestion;
        window.cancelEdit = cancelEdit;
        window.toggleUserStats = toggleUserStats;
        window.addNewUser = addNewUser;
        window.blockUser = blockUser;
        window.unblockUser = unblockUser;
        window.toggleSubsection = toggleSubsection;
        window.showAddQuestionForm = showAddQuestionForm;
        window.cancelAddQuestion = cancelAddQuestion;
        window.saveNewQuestionAtBottom = saveNewQuestionAtBottom;
        window.render = render;

        // Start App
        loadData();
        cleanOldStats();

        if (!checkTelegramAuth()) {
            render();
        }

        setInterval(cleanOldStats, 24 * 60 * 60 * 1000);
    </script>
</body>
</html>
